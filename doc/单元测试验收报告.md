# 单元测试验收报告
## 1. 测试概述
本次测试旨在验证医院挂号系统后端核心业务逻辑的正确性。测试范围涵盖认证、医生管理、挂号流程、支付处理、通知服务、后台管理、患者服务及AI智能助手。测试采用单元测试（Unit Testing）策略，通过 Mock 技术隔离数据库与外部依赖，专注于最小可测单元的功能验证，并覆盖典型业务路径及若干极端/异常输入场景，以评估系统的鲁棒性。

## 2. 测试流程与执行记录
根据需求规格及 API 设计，对以下模块进行了单元测试验收：

### 2.1 认证模块 (AuthService & Controller)
**测试目标**: 验证用户注册、登录及密码管理的安全性与逻辑正确性。

| 测试用例ID | 测试场景 | 预期结果 | 实际结果 | 状态 |
| :--- | :--- | :--- | :--- | :--- |
| AUTH-001 | 注册时用户名已存在 | 抛出"用户名已存在"错误 | 抛出预期错误 | 通过 |
| AUTH-002 | 新用户注册 | 成功创建用户并返回ID | 返回ID与用户名 | 通过 |
| AUTH-003 | 登录时用户不存在 | 抛出"用户不存在"错误 | 抛出预期错误 | 通过 |
| AUTH-004 | 登录时密码错误 | 抛出"密码错误"错误 | 抛出预期错误 | 通过 |
| AUTH-005 | 登录成功 | 返回 JWT Token | 返回 Token | 通过 |
| AUTH-006 | 修改密码 | 验证旧密码并更新新密码 | 更新成功 | 通过 |
| AUTH-007 | 修改密码时用户缺失 | 抛出"用户不存在"错误 | 抛出预期错误 | 通过 |
| AUTH-008 | 修改密码时旧密码错误 | 抛出"旧密码不正确"错误 | 抛出预期错误 | 通过 |
| AUTH-009 | 使用超长用户名与复杂密码注册 | 能正常完成注册且不抛异常 | 注册成功，返回用户信息 | 通过 |

### 2.2 医生服务模块 (DoctorService & Controller)
**测试目标**: 验证医生排班信息的查询与数据格式化逻辑。

| 测试用例ID | 测试场景 | 预期结果 | 实际结果 | 状态 |
| :--- | :--- | :--- | :--- | :--- |
| DOC-001 | 获取医生排班可用性 | 正确计算各号源类型的剩余量 | 计算正确 (Total - Booked) | 通过 |
| DOC-002 | 排班缺少额外配置信息 | 回退到默认号源类型处理 | 默认类型计算正确 | 通过 |
| DOC-003 | Controller获取可用性接口 | 返回标准 JSON 格式数据 | 返回 200 OK 及数据 | 通过 |
| DOC-004 | 查询不存在的医生 | 返回 404 错误 | 返回 404 Not Found | 通过 |

### 2.3 挂号核心模块 (RegistrationService & Controller)
**测试目标**: 验证挂号核心流程，包括正常预约、满员候补及取消订单后的候补晋升机制。

| 测试用例ID | 测试场景 | 预期结果 | 实际结果 | 状态 |
| :--- | :--- | :--- | :--- | :--- |
| REG-001 | 号源充足时挂号 | 创建状态为 confirmed 的订单 | 订单状态 confirmed | 通过 |
| REG-002 | 号源耗尽时预约 | 创建状态为 waiting 的候补订单 | 订单状态 waiting (waitlist=1) | 通过 |
| REG-003 | 取消已确认订单 | 释放号源并自动晋升最早的候补订单 | 候补订单变更为 confirmed | 通过 |
| REG-004 | 创建挂号并支付 | 确认订单且金额>0时创建支付单 | 返回 payment_required=true | 通过 |
| REG-005 | 免费挂号 | 金额为0时不创建支付单 | 返回 payment_required=false | 通过 |

### 2.4 支付模块 (PaymentService & Controller)
**测试目标**: 验证支付记录的创建与状态流转。

| 测试用例ID | 测试场景 | 预期结果 | 实际结果 | 状态 |
| :--- | :--- | :--- | :--- | :--- |
| PAY-001 | 创建支付单 | 数据库插入记录并返回 | 记录创建成功 | 通过 |
| PAY-002 | 标记支付完成 | 更新状态为 paid 并记录时间 | 状态更新成功 | 通过 |
| PAY-003 | 根据ID查询支付 | 返回对应支付详情 | 查询成功 | 通过 |
| PAY-004 | 查询用户支付列表 | 返回该用户的支付记录数组 | 返回数组 | 通过 |
| PAY-005 | 支付回调更新订单 | 支付成功后更新订单状态 | 订单变更为 confirmed | 通过 |
| PAY-006 | 创建负金额支付单 | 能正常插入记录并返回，不影响系统稳定性 | 记录创建成功，未引发异常 | 通过 |

### 2.5 通知模块 (NotificationService)
**测试目标**: 验证消息通知的触发逻辑及去重机制。

| 测试用例ID | 测试场景 | 预期结果 | 实际结果 | 状态 |
| :--- | :--- | :--- | :--- | :--- |
| NOT-001 | 用户有邮箱时发送通知 | 调用 SMTP 服务发送邮件 | SMTP Stub 被调用 | 通过 |
| NOT-002 | 用户无邮箱时 | 跳过发送并标记状态 | 未调用 SMTP，DB状态更新 | 通过 |

### 2.6 后台管理模块 (AdminService & Controller)
**测试目标**: 验证科室、医生、排班及审核管理功能。

| 测试用例ID | 测试场景 | 预期结果 | 实际结果 | 状态 |
| :--- | :--- | :--- | :--- | :--- |
| ADM-001 | 创建科室 | 插入新科室记录 | 插入成功 | 通过 |
| ADM-002 | 创建医生 | 插入医生及初始审核记录 | 插入成功 | 通过 |
| ADM-003 | 设置医生密码 | 更新或创建医生账号 | 更新成功 | 通过 |
| ADM-004 | 管理排班 | 创建或更新排班记录 | 操作成功 | 通过 |
| ADM-005 | 审核医生资料 | 更新审核状态 | 状态更新成功 | 通过 |

### 2.7 患者服务模块 (PatientService & Controller)
**测试目标**: 验证患者档案管理及实名认证逻辑。

| 测试用例ID | 测试场景 | 预期结果 | 实际结果 | 状态 |
| :--- | :--- | :--- | :--- | :--- |
| PAT-001 | 获取个人档案 | 返回脱敏后的档案信息 | 返回正确 | 通过 |
| PAT-002 | 提交档案(校验通过) | 保存或更新档案 | 保存成功 | 通过 |
| PAT-003 | 提交档案(校验失败) | 拒绝保存并返回错误 | 返回校验失败 | 通过 |
| PAT-004 | 职工名单验证 | 验证姓名/工号/身份证是否匹配 | 匹配逻辑正确 | 通过 |

### 2.8 AI智能助手模块 (AIService)
**测试目标**: 验证AI对话、指令解析及API调用逻辑。

| 测试用例ID | 测试场景 | 预期结果 | 实际结果 | 状态 |
| :--- | :--- | :--- | :--- | :--- |
| AI-001 | API密钥校验 | 缺失密钥时抛出异常 | 抛出预期异常 | 通过 |
| AI-002 | 解析导航指令 | 提取文本中的导航动作 | 解析正确 | 通过 |
| AI-003 | 解析表单指令 | 提取文本中的表单填充动作 | 解析正确 | 通过 |
| AI-004 | 清理回复文本 | 移除指令标记保留可读文本 | 清理正确 | 通过 |
| AI-005 | 调用DeepSeek API | 正确构造请求并处理响应 | 请求参数正确 | 通过 |
| AI-006 | API错误处理 | 捕获并封装API错误 | 错误处理正确 | 通过 |
| AI-007 | 回复中包含畸形fillForm JSON | 忽略无法解析的指令片段且不抛异常 | 未抛异常，返回空动作列表 | 通过 |



## 3. 下一版本改进意见与整改建议 
	后续在迭代业务功能时，可以结合这些单元测试反馈，对模块本身做一些设计层面的优化，以提升可测试性和可维护性，例如：
	1.对依赖数据库、MQ、HTTP 调用的 Service，引入依赖注入或适配层，减少在函数内部直接 new / require 外部依赖，使得后续单元测试可以更细粒度地替换依赖、构造特殊场景。
	2.将当前相对复杂、包含多重分支的大型函数拆分为更小的纯函数（pure function），例如将挂号 Service 中的“状态判定”“费用计算”“消息发布”等逻辑拆分出来，便于为每个子逻辑单独编写针对性单元测试。
	3.在 Controller 与 Service 之间保持清晰的职责边界：Controller 负责参数解析、权限校验与响应封装，Service 专注业务规则与数据读写。后续通过单元测试分别验证“接口入参与返回结构”和“内部业务决策”，提高测试覆盖的针对性与可读性。
	   

> 


